name: Update Content from Issue

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  update:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'content-update')
    steps:
      - name: Parse Issue Body
        id: parse
        run: |
          BODY="${{ github.event.issue.body }}"

          # Helper function to extract value. 
          # Matches "### Label\n\nValue" format commonly used by GitHub Issue Forms
          extract_value() {
            local label="$1"
            echo "$BODY" | grep -A 2 "$label" | tail -n 1 | tr -d '\r'
          }

          # We can also use specific IDs if we trust the format strictly, but grep is okay for this simple case
          # Note: The issue form parser in the prompt was slightly different, adapting to standard Issue Forms behavior.
          # GitHub Issue Forms usually format as "### H3 Label\n\nValue\n"

          MAP_NAME=$(extract_value "### Ø§Ø³Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø©")
          VIDEO_LINK=$(extract_value "### Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ")
          MAP_LINK=$(extract_value "### Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©")
          CHANNEL=$(extract_value "### Ø§Ù„Ù‚Ù†Ø§Ø©")
          SECRET_TOKEN=$(extract_value "### ğŸ”‘ Ø±Ù…Ø² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©")

          echo "MAP_NAME<<EOF" >> $GITHUB_ENV
          echo "$MAP_NAME" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "VIDEO_LINK=$VIDEO_LINK" >> $GITHUB_ENV
          echo "MAP_LINK=$MAP_LINK" >> $GITHUB_ENV
          echo "CHANNEL=$CHANNEL" >> $GITHUB_ENV
          echo "SECRET_TOKEN=$SECRET_TOKEN" >> $GITHUB_ENV

      - name: Authenticate Manager
        env:
          PROVIDED_TOKEN: ${{ env.SECRET_TOKEN }}
          MANAGER_SECRET: ${{ secrets.MANAGER_SECRET_TOKEN }}
        run: |
          if [ "$PROVIDED_TOKEN" != "$MANAGER_SECRET" ]; then
            echo "Authentication failed! Invalid secret token."
            exit 1
          fi

      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Update JSON file
        env:
          IS_DELETE: ${{ contains(github.event.issue.labels.*.name, 'delete-map') }}
          IS_BUMP: ${{ contains(github.event.issue.labels.*.name, 'bump-map') }}
        run: |
          node -e '
            const fs = require("fs");
            const path = "config/links.json";
            
            try {
                if (!fs.existsSync(path)) {
                    console.error("Error: config/links.json not found!");
                    process.exit(1);
                }

                const links = JSON.parse(fs.readFileSync(path, "utf8"));
                
                const mapName = process.env.MAP_NAME ? process.env.MAP_NAME.trim() : "";
                const videoLink = process.env.VIDEO_LINK ? process.env.VIDEO_LINK.trim() : "";
                const mapLink = process.env.MAP_LINK ? process.env.MAP_LINK.trim() : "";
                const channel = process.env.CHANNEL ? process.env.CHANNEL.trim() : "";
                const isDelete = process.env.IS_DELETE === "true";
                const isBump = process.env.IS_BUMP === "true";

                if (!channel || !links[channel]) {
                    console.error(`Error: Channel "${channel}" not found in links.json. Available channels: ${Object.keys(links).join(", ")}`);
                    process.exit(1);
                }

                console.log(`Processing action for channel: ${channel}`);
                console.log(`Map Name: ${mapName}`);

                if (isDelete) {
                    console.log("Operation: DELETE");
                    const originalLength = links[channel].length;
                    links[channel] = links[channel].filter(item => item.map_name.trim() !== mapName);
                    
                    if (links[channel].length === originalLength) {
                        console.error(`Error: Could not find map with name "${mapName}" in channel "${channel}" to delete.`);
                        process.exit(1);
                    }
                    console.log(`Successfully deleted "${mapName}".`);
                } else if (isBump) {
                    console.log("Operation: BUMP (Move to Top)");
                    const index = links[channel].findIndex(item => item.map_name.trim() === mapName);
                    
                    if (index === -1) {
                         console.error(`Error: Could not find map with name "${mapName}" in channel "${channel}" to move.`);
                         process.exit(1);
                    }
                    
                    if (index === 0) {
                        console.log("Map is already at the top.");
                    } else {
                        const item = links[channel].splice(index, 1)[0];
                        links[channel].unshift(item);
                        console.log(`Successfully moved "${mapName}" to the top.`);
                    }
                } else {
                    console.log("Operation: ADD");
                    const newItem = {
                        video_link: videoLink,
                        map_name: mapName,
                        map_link: mapLink
                    };
                    
                    // Simple validation
                    if (!mapName || !videoLink || !mapLink) {
                         console.error("Error: Missing required fields for ADD operation.");
                         process.exit(1);
                    }

                    links[channel].unshift(newItem); // Add to the beginning
                    console.log(`Successfully added "${mapName}".`);
                }
                
                fs.writeFileSync(path, JSON.stringify(links, null, 2));
                console.log("links.json updated successfully!");
                
            } catch (error) {
                console.error("Script failed:", error);
                process.exit(1);
            }
          '

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update content from issue #${{ github.event.issue.number }}"
          commit_user_name: "Content Bot"
          commit_user_email: "actions@github.com"
          commit_author: "Content Bot <actions@github.com>"

      - name: Add Success Comment and Close Issue
        uses: peter-evans/close-issue@v2
        with:
          comment: "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø³ØªØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø®Ù„Ø§Ù„ Ø¯Ù‚Ø§Ø¦Ù‚. (Content updated successfully!)"
